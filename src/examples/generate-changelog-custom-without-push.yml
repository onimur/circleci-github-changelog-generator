description: >
  Generate Changelog with custom parameters and store the file on folder tmp/.persist
usage:
  version: 2.1

  orbs:
    github-changelog-generator: onimur/github-changelog-generator@x.y.z
    # This orb is optional to facilitate the recovery of the file that had been sent by "persist to workspace".
    # You can check it out here: https://github.com/onimur/circleci-persist-files
    persist: onimur/persist@x.y.z

  orb_tagged_filters: &orb_tagged_filters
    branches:
      ignore: /.*/
    tags:
      only: /^\d+\.\d+\.\d+$/ #for tag 1.2.3

  jobs:
    machine: true
    steps:
      - persist/attach-at-dir
      - run:
          name: Print changelog
          command: |
            find .
            if [[ -f "./tmp/.persist/CUSTOM-CHANGELOG.md" ]] ; then
              cat "./tmp/.persist/CUSTOM-CHANGELOG.md.txt"
              echo "This is a file - Test Pass"
            else
              echo "This is not a file"
              exit 1
            fi

  workflows:
    tagged-publish: # run job for all tags
      jobs:
        - github-changelog-generator/changelog-custom:
            steps-before:
              - checkout
            context: your-context           # Case contain your Github Token
            token: GITHUB_TOKEN             # Token as env_var
            push-git: false                 # The changelog will be save on store artifacts (Circle CI)
            header-label: "# My Changelog"
            date-format: "%d-%m-%Y"
            output: CUSTOM-CHANGELOG.md
            breaking-label: "**Breaking**"
            bugs-label: "**Bugs**"
            filters: *orb_tagged_filters    # Trigger to only tag
        - print-changelog:
            filters: *orb_tagged_filters
            requires: [github-changelog-generator/changelog-custom]
