description: |
  Push the CHANGELOG.md to github
parameters:
  user:
    default: CIRCLE_PROJECT_USERNAME
    description: |
      Username of the owner of target GitHub repo.
    type: env_var_name
  project:
    default: CIRCLE_PROJECT_REPONAME
    description: |
      Name of project on GitHub.
    type: env_var_name
  bot-name:
    default: CircleCI-bot
    description: |
      User name to commit
    type: string
  bot-email:
    default: circleci@bot-noreply.com
    description: |
      Email to commit
    type: string
  commit-message:
    default: Auto Update changelog
    description: Commit message
    type: string
  output:
    default: CHANGELOG.md
    description: |
      Output file. Default is CHANGELOG.md.
    type: string
  token:
    default: GITHUB_TOKEN
    description: |
      To make push to github remote
    type: env_var_name

steps:
  - run:
      name: Config git
      command: |
        git config credential.helper 'cache --timeout=120'
        git config user.name "<<parameters.bot-name>>"
        git config user.email "<<parameters.bot-email>>"
  - run:
      command: |
        if [ -z "${CIRCLE_TAG+x}" ]; then
          if [[ "$(git show -s --format=%B | head -n 1)" == "<<parameters.commit-message>>" ]]; then
              circleci-agent step halt
          fi
        fi
  - run:
      name: Push the CHANGELOG.md to Github
      command: |
        git add ./<<parameters.output>>
        git commit -m "<<parameters.commit-message>> [skip ci]"
        # Push quietly to prevent showing the token in log
        git push -q https://$<<parameters.token>>@github.com/$<<parameters.user>>/$<<parameters.project>>.git ${CIRCLE_BRANCH}
